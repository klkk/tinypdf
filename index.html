<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 压缩工具 - 高效压缩 PDF 文件</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .drop-zone {
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            background-color: #dbeafe;
            border-color: #3b82f6;
            transform: scale(1.02);
        }
        .file-item {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .toast {
            animation: toastIn 0.3s ease-out;
        }
        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .compression-option {
            transition: all 0.2s ease;
        }
        .compression-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-file-pdf text-red-500 text-2xl"></i>
                    <h1 class="text-2xl font-bold text-gray-900">PDF 压缩工具</h1>
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded">高效压缩</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="clearAll" class="text-gray-600 hover:text-gray-900 transition-colors">
                        <i class="fas fa-trash-alt mr-2"></i>清空全部
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Upload Zone -->
        <div class="bg-white rounded-lg shadow-md p-8 mb-8">
            <div id="dropZone" class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-12 text-center cursor-pointer hover:border-blue-400 transition-colors">
                <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">拖拽 PDF 文件到这里</h3>
                <p class="text-gray-500 mb-4">或者点击选择文件</p>
                <button class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    <i class="fas fa-folder-open mr-2"></i>选择文件
                </button>
                <input type="file" id="fileInput" accept=".pdf" multiple class="hidden">
                <p class="text-sm text-gray-400 mt-4">支持多个文件同时上传，最大 50MB</p>
            </div>
        </div>

        <!-- Compression Settings -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">
                <i class="fas fa-cog mr-2"></i>压缩设置
            </h3>
            
            <!-- Compression Mode Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">压缩模式</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="compression-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400" data-mode="balanced">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-balance-scale text-blue-500 text-xl mr-2"></i>
                            <h4 class="font-semibold">平衡模式</h4>
                        </div>
                        <p class="text-sm text-gray-600">质量和文件大小的最佳平衡</p>
                    </div>
                    <div class="compression-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-green-400" data-mode="aggressive">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-compress-arrows-alt text-green-500 text-xl mr-2"></i>
                            <h4 class="font-semibold">强力压缩</h4>
                        </div>
                        <p class="text-sm text-gray-600">最大程度减小文件大小</p>
                    </div>
                    <div class="compression-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-purple-400" data-mode="quality">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-gem text-purple-500 text-xl mr-2"></i>
                            <h4 class="font-semibold">高质量</h4>
                        </div>
                        <p class="text-sm text-gray-600">保持最佳图像质量</p>
                    </div>
                </div>
            </div>

            <!-- Advanced Settings -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">图像质量</label>
                    <div class="flex items-center space-x-3">
                        <input type="range" id="imageQuality" min="10" max="100" value="60" class="flex-1">
                        <span id="qualityValue" class="text-sm font-medium text-gray-600 w-12">60%</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">降低图像质量可显著减小文件大小</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">图像分辨率</label>
                    <select id="imageResolution" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="original">保持原始分辨率</option>
                        <option value="150">150 DPI (推荐)</option>
                        <option value="100">100 DPI</option>
                        <option value="72">72 DPI</option>
                    </select>
                </div>
            </div>

            <!-- Additional Options -->
            <div class="mt-6 space-y-3">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="removeMetadata" class="mr-2 h-4 w-4 text-blue-600 rounded">
                    <span class="text-sm text-gray-700">删除元数据（作者、创建日期等）</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="removeThumbnails" class="mr-2 h-4 w-4 text-blue-600 rounded">
                    <span class="text-sm text-gray-700">删除缩略图</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="compressText" checked class="mr-2 h-4 w-4 text-blue-600 rounded">
                    <span class="text-sm text-gray-700">压缩文本内容</span>
                </label>
            </div>

            <div class="mt-6">
                <button id="compressAll" class="w-full bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed font-semibold">
                    <i class="fas fa-compress mr-2"></i>开始压缩
                </button>
            </div>
        </div>

        <!-- File List -->
        <div id="fileList" class="space-y-4">
            <!-- Files will be dynamically added here -->
        </div>

        <!-- Statistics -->
        <div id="statistics" class="hidden bg-white rounded-lg shadow-md p-6 mt-8">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">
                <i class="fas fa-chart-bar mr-2"></i>压缩统计
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <p class="text-3xl font-bold text-blue-600" id="totalFiles">0</p>
                    <p class="text-gray-600">总文件数</p>
                </div>
                <div class="text-center">
                    <p class="text-3xl font-bold text-green-600" id="originalSize">0 MB</p>
                    <p class="text-gray-600">原始大小</p>
                </div>
                <div class="text-center">
                    <p class="text-3xl font-bold text-purple-600" id="compressedSize">0 MB</p>
                    <p class="text-gray-600">压缩后大小</p>
                </div>
                <div class="text-center">
                    <p class="text-3xl font-bold text-red-600" id="savedSpace">0%</p>
                    <p class="text-gray-600">节省空间</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Global variables
        let files = [];
        let isCompressing = false;
        let selectedMode = 'balanced';

        // DOM elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const compressAllBtn = document.getElementById('compressAll');
        const clearAllBtn = document.getElementById('clearAll');
        const imageQuality = document.getElementById('imageQuality');
        const qualityValue = document.getElementById('qualityValue');
        const imageResolution = document.getElementById('imageResolution');
        const removeMetadata = document.getElementById('removeMetadata');
        const removeThumbnails = document.getElementById('removeThumbnails');
        const compressText = document.getElementById('compressText');
        const statistics = document.getElementById('statistics');

        // Event listeners
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        dropZone.addEventListener('dragover', handleDragOver);
        dropZone.addEventListener('dragleave', handleDragLeave);
        dropZone.addEventListener('drop', handleDrop);
        compressAllBtn.addEventListener('click', compressAllFiles);
        clearAllBtn.addEventListener('click', clearAllFiles);
        imageQuality.addEventListener('input', (e) => {
            qualityValue.textContent = e.target.value + '%';
        });

        // Compression mode selection
        document.querySelectorAll('.compression-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.compression-option').forEach(opt => {
                    opt.classList.remove('border-blue-500', 'bg-blue-50');
                });
                this.classList.add('border-blue-500', 'bg-blue-50');
                selectedMode = this.dataset.mode;
                
                // Update settings based on mode
                switch(selectedMode) {
                    case 'balanced':
                        imageQuality.value = 60;
                        imageResolution.value = '150';
                        removeMetadata.checked = true;
                        removeThumbnails.checked = false;
                        break;
                    case 'aggressive':
                        imageQuality.value = 30;
                        imageResolution.value = '72';
                        removeMetadata.checked = true;
                        removeThumbnails.checked = true;
                        break;
                    case 'quality':
                        imageQuality.value = 85;
                        imageResolution.value = 'original';
                        removeMetadata.checked = false;
                        removeThumbnails.checked = false;
                        break;
                }
                qualityValue.textContent = imageQuality.value + '%';
            });
        });

        // Select balanced mode by default
        document.querySelector('[data-mode="balanced"]').click();

        // File handling functions
        function handleFileSelect(e) {
            const selectedFiles = Array.from(e.target.files);
            addFiles(selectedFiles);
            e.target.value = '';
        }

        function handleDragOver(e) {
            e.preventDefault();
            dropZone.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const droppedFiles = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
            addFiles(droppedFiles);
        }

        function addFiles(newFiles) {
            let addedCount = 0;
            newFiles.forEach(file => {
                if (file.size > 50 * 1024 * 1024) {
                    showToast(`文件 ${file.name} 超过 50MB 限制`, 'error');
                    return;
                }
                
                const exists = files.some(f => f.name === file.name && f.size === file.size);
                if (exists) {
                    showToast(`文件 ${file.name} 已存在`, 'warning');
                    return;
                }
                
                const fileId = Date.now() + Math.random();
                const fileObj = {
                    id: fileId,
                    file: file,
                    name: file.name,
                    size: file.size,
                    compressed: null,
                    status: 'pending'
                };
                
                files.push(fileObj);
                renderFileItem(fileObj);
                addedCount++;
            });
            
            if (addedCount > 0) {
                showToast(`成功添加 ${addedCount} 个文件`, 'success');
            }
            updateUI();
        }

        function renderFileItem(fileObj) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item bg-white rounded-lg shadow-md p-4';
            fileItem.id = `file-${fileObj.id}`;
            
            fileItem.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <i class="fas fa-file-pdf text-red-500 text-2xl"></i>
                        <div>
                            <h4 class="font-semibold text-gray-700">${fileObj.name}</h4>
                            <p class="text-sm text-gray-500">${formatFileSize(fileObj.size)}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm text-gray-600">压缩后</p>
                            <p class="font-semibold text-green-600" id="compressed-size-${fileObj.id}">-</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">节省</p>
                            <p class="font-semibold text-blue-600" id="saved-percent-${fileObj.id}">-</p>
                        </div>
                        <button onclick="removeFile(${fileObj.id})" class="text-red-500 hover:text-red-700 transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="bg-gray-200 rounded-full h-2 overflow-hidden">
                        <div id="progress-${fileObj.id}" class="progress-bar bg-blue-500 h-full w-0"></div>
                    </div>
                    <p id="status-${fileObj.id}" class="text-sm text-gray-600 mt-1">等待压缩</p>
                </div>
            `;
            
            fileList.appendChild(fileItem);
        }

        async function compressAllFiles() {
            if (isCompressing) {
                showToast('正在压缩中，请稍候...', 'warning');
                return;
            }
            
            if (files.length === 0) {
                showToast('请先上传 PDF 文件', 'warning');
                return;
            }
            
            const pendingFiles = files.filter(f => f.status === 'pending');
            if (pendingFiles.length === 0) {
                showToast('所有文件已压缩完成', 'info');
                return;
            }
            
            isCompressing = true;
            compressAllBtn.disabled = true;
            compressAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>压缩中...';
            
            try {
                for (const fileObj of files) {
                    if (fileObj.status === 'pending') {
                        await compressFile(fileObj);
                    }
                }
                showToast('所有文件压缩完成！', 'success');
            } catch (error) {
                console.error('Compression error:', error);
                showToast('压缩过程中出现错误', 'error');
            } finally {
                isCompressing = false;
                compressAllBtn.disabled = false;
                compressAllBtn.innerHTML = '<i class="fas fa-compress mr-2"></i>开始压缩';
                updateStatistics();
            }
        }

        async function compressFile(fileObj) {
            try {
                fileObj.status = 'compressing';
                updateFileStatus(fileObj.id, 'compressing', 0);
                
                // Load the PDF with PDF.js for better image processing
                const arrayBuffer = await fileObj.file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                
                // Get compression settings
                const quality = parseInt(imageQuality.value) / 100;
                const resolution = imageResolution.value;
                
                // Progress simulation
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 85) progress = 85;
                    updateFileStatus(fileObj.id, 'compressing', progress);
                }, 200);
                
                // Remove metadata if selected
                if (removeMetadata.checked) {
                    pdfDoc.setTitle('');
                    pdfDoc.setAuthor('');
                    pdfDoc.setSubject('');
                    pdfDoc.setKeywords([]);
                    pdfDoc.setProducer('');
                    pdfDoc.setCreator('');
                }
                
                // Get all pages
                const pages = pdfDoc.getPages();
                
                // Process each page for image compression
                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i];
                    
                    // Get page dimensions
                    const { width, height } = page.getSize();
                    
                    // Extract and compress images (simplified approach)
                    // Note: Full image extraction and recompression would require more complex processing
                    // This is a placeholder for the actual image compression logic
                }
                
                // Save with optimized settings
                const saveOptions = {
                    useObjectStreams: true,
                    addDefaultPage: false,
                    objectsPerTick: 100,
                    // Additional optimization options
                    compress: true,
                };
                
                // Apply aggressive compression for selected mode
                if (selectedMode === 'aggressive') {
                    saveOptions.objectsPerTick = 200;
                }
                
                const compressedPdfBytes = await pdfDoc.save(saveOptions);
                
                clearInterval(progressInterval);
                updateFileStatus(fileObj.id, 'compressing', 100);
                
                const compressedBlob = new Blob([compressedPdfBytes], { type: 'application/pdf' });
                fileObj.compressed = compressedBlob;
                fileObj.status = 'completed';
                
                const originalSize = fileObj.size;
                const compressedSize = compressedBlob.size;
                const savedPercent = ((originalSize - compressedSize) / originalSize * 100).toFixed(1);
                
                updateFileStatus(fileObj.id, 'completed', 100);
                document.getElementById(`compressed-size-${fileObj.id}`).textContent = formatFileSize(compressedSize);
                document.getElementById(`saved-percent-${fileObj.id}`).textContent = savedPercent + '%';
                
                // Add download button
                const fileItem = document.getElementById(`file-${fileObj.id}`);
                if (!fileItem.querySelector('.download-btn')) {
                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = 'download-btn ml-4 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm';
                    downloadBtn.innerHTML = '<i class="fas fa-download mr-2"></i>下载';
                    downloadBtn.onclick = () => downloadFile(fileObj);
                    fileItem.querySelector('.flex.items-center.justify-between').appendChild(downloadBtn);
                }
                
                showToast(`${fileObj.name} 压缩完成，节省 ${savedPercent}%`, 'success');
                
            } catch (error) {
                console.error('Compression error:', error);
                fileObj.status = 'error';
                updateFileStatus(fileObj.id, 'error', 0);
                throw error;
            }
        }

        function updateFileStatus(fileId, status, progress) {
            const progressBar = document.getElementById(`progress-${fileId}`);
            const statusText = document.getElementById(`status-${fileId}`);
            
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
            
            if (statusText) {
                switch (status) {
                    case 'pending':
                        statusText.textContent = '等待压缩';
                        statusText.className = 'text-sm text-gray-600 mt-1';
                        break;
                    case 'compressing':
                        statusText.textContent = `压缩中... ${Math.round(progress)}%`;
                        statusText.className = 'text-sm text-blue-600 mt-1';
                        break;
                    case 'completed':
                        statusText.textContent = '压缩完成';
                        statusText.className = 'text-sm text-green-600 mt-1';
                        break;
                    case 'error':
                        statusText.textContent = '压缩失败';
                        statusText.className = 'text-sm text-red-600 mt-1';
                        break;
                }
            }
        }

        function removeFile(fileId) {
            files = files.filter(f => f.id !== fileId);
            const fileItem = document.getElementById(`file-${fileId}`);
            if (fileItem) {
                fileItem.remove();
            }
            updateUI();
        }

        function clearAllFiles() {
            if (files.length === 0) return;
            
            if (confirm('确定要清空所有文件吗？')) {
                files = [];
                fileList.innerHTML = '';
                updateUI();
                showToast('已清空所有文件', 'info');
            }
        }

        function downloadFile(fileObj) {
            if (!fileObj.compressed) return;
            
            const url = URL.createObjectURL(fileObj.compressed);
            const a = document.createElement('a');
            a.href = url;
            a.download = `compressed_${fileObj.name}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function updateUI() {
            const hasPendingFiles = files.some(f => f.status === 'pending');
            compressAllBtn.disabled = files.length === 0 || !hasPendingFiles || isCompressing;
            updateStatistics();
        }

        function updateStatistics() {
            if (files.length === 0) {
                statistics.classList.add('hidden');
                return;
            }
            
            statistics.classList.remove('hidden');
            
            const totalFiles = files.length;
            let originalSize = 0;
            let compressedSize = 0;
            
            files.forEach(file => {
                originalSize += file.size;
                if (file.compressed) {
                    compressedSize += file.compressed.size;
                }
            });
            
            const savedPercent = originalSize > 0 ? ((originalSize - compressedSize) / originalSize * 100).toFixed(1) : 0;
            
            document.getElementById('totalFiles').textContent = totalFiles;
            document.getElementById('originalSize').textContent = formatFileSize(originalSize);
            document.getElementById('compressedSize').textContent = formatFileSize(compressedSize);
            document.getElementById('savedSpace').textContent = savedPercent + '%';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast bg-white rounded-lg shadow-lg p-4 flex items-center space-x-3';
            
            let icon, bgColor;
            switch (type) {
                case 'success':
                    icon = 'fa-check-circle';
                    bgColor = 'text-green-500';
                    break;
                case 'error':
                    icon = 'fa-exclamation-circle';
                    bgColor = 'text-red-500';
                    break;
                case 'warning':
                    icon = 'fa-exclamation-triangle';
                    bgColor = 'text-yellow-500';
                    break;
                default:
                    icon = 'fa-info-circle';
                    bgColor = 'text-blue-500';
            }
            
            toast.innerHTML = `
                <i class="fas ${icon} ${bgColor} text-xl"></i>
                <span class="text-gray-700">${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Initialize
        updateUI();
    </script>
</body>
</html>
